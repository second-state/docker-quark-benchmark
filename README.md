## Usage

- Install [Quark][] and [gVisor][].
- Install [Docker buildx plugin][buildx]
- Build and install [second-state/runwasi][runwasi]
- Use [wasmedge branch of moby](https://github.com/CaptainVincent/moby/tree/wasmedge) for dockerd
- Start `dockerd` with `quark` and `runsc` runtime and `config/daemon.json` config:

```
sudo dockerd -D -H unix:///tmp/dockerd/docker.sock \
    --data-root /tmp/dockerd/root \
    --pidfile /tmp/dockerd/docker.pid \
    --config-file config/daemon.json \
    --add-runtime quark=/usr/local/bin/quark \
    --add-runtime runsc=/usr/local/bin/runsc
```

- Create and use docker context:

```
docker context create benchmark --docker host=unix:///tmp/dockerd/docker.sock
docker context use benchmark
```

- Run benchmarks:

```
./benchmark.sh <COUNT>
```

- Results (sec, lower is better):

```
### container_start_time
benchmark_name                     min     max     avg     std
benchmark_runc_nodejs            0.416   0.509   0.473   0.029
benchmark_quark_nodejs           0.595   0.784   0.658   0.052
benchmark_gvisor_nodejs          0.752   0.865   0.808   0.033
benchmark_wasmedge_quickjs       0.343   0.465   0.408   0.037

### container_execution_time
benchmark_name                     min     max     avg     std
benchmark_runc_nodejs           20.457  20.505  20.481   0.018
benchmark_quark_nodejs          20.763  20.866  20.790   0.033
benchmark_gvisor_nodejs         20.644  20.845  20.756   0.056
benchmark_wasmedge_quickjs      54.324  58.383  55.724   1.460
```

## Environments

- **benchmark_runc_nodejs**
    - Use docker default runtime (runc) to start a `node:16` container to run `v8-v7` benchmark.
- **benchmark_quark_nodejs**
    - Use [Quark][] runtime to start a `node:16` container to run `v8-v7` benchmark.
- **benchmark_gvisor_nodejs**
    - Use [gVisor][] runtime to start a `node:16` container to run `v8-v7` benchmark.
- **benchmark_wasmedge_quickjs**
    - Use `wasmedge_quickjs.wasm` from [wasmedge-quickjs][].
    - Compile `wasmedge_quickjs.wasm` to `wasmedge_quickjs.wasm.so` using `wasmedgec`.
    - Use [second-state/runwasi][runwasi] WasmEdge runtime to start a container,
      which uses `wasmedge_quickjs.wasm.so` as a javascript engine to run `v8-v7` benchmark.

## Node.js Benchmarks

Here we use [V8 benchmark suite version 7][v8-v7]. It contains the following benchmarks:

- `crypto.js`
    - Crypto related benchmarks.
- `deltablue.js`
    - A JavaScript implementation of the DeltaBlue constraint-solving algorithm.
- `earley-boyer.js`
    - Classic Scheme benchmarks translated to JavaScript.
- `navier-stokes.js`
    - 2D NavierStokes equations solver, heavily manipulates double precision arrays.
- `raytrace.js`
    - Ray tracer benchmark.
- `regexp.js`
    - Regular expression benchmark generated by extracting regular expression operations from 50 of the most popular web pages.
- `richards.js`
    - OS kernel simulation benchmark, originally written in BCPL.
- `splay.js`
    - Data manipulation benchmark that deals with splay trees and exercises the automatic memory management subsystem.
- Check [here](https://developers.google.com/octane/benchmark) for more information.

### Run the Node.js Benchmarks

- Run it seperately:

```
$ cd nodejs/v8-v7/
$ node crypto.js

Crypto: 46674
----
Score (version 7): 46674
```

- Run all the benchmarks (score, higher is better):

```
$ cd nodejs/v8-v7/
$ node v8-v7.js

Crypto: 46714
DeltaBlue: 83686
EarleyBoyer: 65225
NavierStokes: 43691
RayTrace: 63639
RegExp: 9799
Richards: 45886
Splay: 37323
----
Score (version 7): 43096
```

[Quark]: https://github.com/QuarkContainer/Quark
[gVisor]: https://github.com/google/gvisor
[buildx]: https://github.com/docker/buildx
[v8-v7]: https://github.com/mozilla/arewefastyet/tree/master/benchmarks/v8-v7
[wasmedge-quickjs]: https://github.com/second-state/wasmedge-quickjs
[runwasi]: https://github.com/second-state/runwasi.git
